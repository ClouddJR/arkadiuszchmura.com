<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Do not change the package name or class name of your AppWidgetProvider | Arkadiusz Chmura</title>
<meta name=keywords content><meta name=description content="If you do this, widgets that were placed on the home screen by your users will simply disappear."><meta name=author content><link rel=canonical href=https://arkadiuszchmura.com/posts/do-not-change-the-package-name-or-class-name-of-your-app-widget-provider/><link crossorigin=anonymous href=/assets/css/stylesheet.min.e3c510e7f6e31768ab67de3a6e99624800311d1e456b449249b149b07d3f1d65.css integrity="sha256-48UQ5/bjF2irZ946bpliSAAxHR5Fa0SSSbFJsH0/HWU=" rel="preload stylesheet" as=style><link rel=icon href=https://arkadiuszchmura.com/favicon.ico><link rel=apple-touch-icon href=https://arkadiuszchmura.com/apple-touch-icon.png><link rel=alternate hreflang=en href=https://arkadiuszchmura.com/posts/do-not-change-the-package-name-or-class-name-of-your-app-widget-provider/><script async src="https://www.googletagmanager.com/gtag/js?id=G-9BS720SLJB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9BS720SLJB")}</script><meta name=twitter:title content="Do not change the package name or class name of your AppWidgetProvider | Arkadiusz Chmura"><meta name=twitter:description content="If you do this, widgets that were placed on the home screen by your users will simply disappear."><meta property="og:title" content="Do not change the package name or class name of your AppWidgetProvider | Arkadiusz Chmura"><meta property="og:description" content="If you do this, widgets that were placed on the home screen by your users will simply disappear."><meta property="og:type" content="article"><meta property="og:url" content="https://arkadiuszchmura.com/posts/do-not-change-the-package-name-or-class-name-of-your-app-widget-provider/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-22T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-22T00:00:00+00:00"><meta property="og:site_name" content="Arkadiusz Chmura"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://arkadiuszchmura.com/posts/"},{"@type":"ListItem","position":2,"name":"Do not change the package name or class name of your AppWidgetProvider","item":"https://arkadiuszchmura.com/posts/do-not-change-the-package-name-or-class-name-of-your-app-widget-provider/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Do not change the package name or class name of your AppWidgetProvider | Arkadiusz Chmura","name":"Do not change the package name or class name of your AppWidgetProvider","description":"If you do this, widgets that were placed on the home screen by your users will simply disappear.","keywords":[],"wordCount":"866","inLanguage":"en","datePublished":"2022-02-22T00:00:00Z","dateModified":"2022-02-22T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://arkadiuszchmura.com/posts/do-not-change-the-package-name-or-class-name-of-your-app-widget-provider/"},"publisher":{"@type":"Organization","name":"Arkadiusz Chmura","logo":{"@type":"ImageObject","url":"https://arkadiuszchmura.com/favicon.ico"}}}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel=stylesheet><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://arkadiuszchmura.com/ accesskey=h title="Arkadiusz Chmura (Alt + H)">Arkadiusz Chmura</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://arkadiuszchmura.com/archive/ title=Archive>Archive</a></li><li><a href=https://arkadiuszchmura.com/search/ title="Search (Alt + /)" data-no-instant accesskey=/>Search</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://arkadiuszchmura.com/>Home</a>&nbsp;»&nbsp;<a href=https://arkadiuszchmura.com/posts/>Posts</a></div><h1 class=post-title>Do not change the package name or class name of your AppWidgetProvider</h1><div class=post-meta><span class=meta-item><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg>
<span>February 22, 2022</span></span><span class=meta-item>
<svg width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>5 min</span></span></div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>¶</a></h2><p>When creating a widget for your Android app, one of the components that you need to define is a class that extends <a href=https://developer.android.com/reference/android/appwidget/AppWidgetProvider>AppWidgetProvider</a>. Through it, you will receive broadcasts when the widget is updated, enabled, disabled, deleted, resized, etc. You can then act accordingly and, for example, refresh the widget&rsquo;s view to display the newest data.</p><p>I implemented a widget in <a href="https://play.google.com/store/apps/details?id=com.arkadiusz.dayscounter">one of my apps</a> following the steps mentioned <a href=https://developer.android.com/guide/topics/appwidgets>in the documentation</a> and everything was working just fine.</p><p>At least until one day. After noticing that my app is getting bigger, I decided to change the structure of my app a little to package classes by features rather than by layers.</p><p>When I changed the package name of my class extending AppWidgetProvider from</p><pre tabindex=0><code>com.arkadiusz.Provider.MyAppWidgetProvider
</code></pre><p>to</p><pre tabindex=0><code>com.arkadiusz.data.providers.MyAppWidgetProvider
</code></pre><p>and relaunched the app, all app&rsquo;s widgets disappeared from my home screen.</p><p>I can consider myself lucky for noticing this before releasing the next version of the app and causing this problem for all users.</p><p>It is quite strange that changing a package name of one class can produce such a radical effect so let&rsquo;s dive into the Android source code and find out why this is happening.</p><h2 id=behind-the-scenes>Behind the scenes<a hidden class=anchor aria-hidden=true href=#behind-the-scenes>¶</a></h2><p>In Android, a system service responsible for managing widgets across the entire OS is called <a href=https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/appwidget/java/com/android/server/appwidget/AppWidgetServiceImpl.java>AppWidgetService</a>. This is a component that knows, among other things, <strong>how</strong> and <strong>when</strong> to update your widgets (based, for example, on the information that you specify in your AppWidgetProviderInfo XML).</p><p>Internally, some of the variables that it holds are as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Widget</span><span class=o>&gt;</span><span class=w> </span><span class=n>mWidgets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Host</span><span class=o>&gt;</span><span class=w> </span><span class=n>mHosts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Provider</span><span class=o>&gt;</span><span class=w> </span><span class=n>mProviders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><ul><li><strong>mWidgets</strong> stores references to all widgets that are placed within all hosts.</li><li><strong>mHosts</strong> stores references to all <a href=https://developer.android.com/reference/android/appwidget/AppWidgetHost>AppWidgetHosts</a>, which are components designed to be used by applications that want to embed widgets in their UI (mostly home screen applications). They provide interaction with the AppWidget service.</li><li><strong>mProviders</strong> stores references to all AppWidgetProviders that were registered by currently installed apps. Each Provider object is identified by a <a href=https://developer.android.com/reference/android/content/ComponentName>ComponentName</a> (which stores two pieces of information - package name and the class name). It also keeps references to all widgets that it is responsible for.</li></ul><p>The AppWidget service also listens for different broadcasts related to application packages (like <code>Intent.ACTION_PACKAGE_ADDED</code> or <code>Intent.ACTION_PACKAGE_REMOVED</code>). It does that to keep its ArrayLists up to date. For example, when a user deletes an app from their device, the service can remove every widget and provider associated with this app because they are no longer needed.</p><p>I mentioned earlier that the service identifies each provider by its ComponentName. Well, if we decide to change the provider&rsquo;s package name or class name, the new ComponentName is going to be <strong>different</strong>. This is the root of the problem.</p><p>Here is what happens when you modify your provider&rsquo;s package name or class name and then update your app:</p><ol><li>The AppWidget service is notified about an application package update via a broadcast.</li><li>It reads the app&rsquo;s manifest file and finds a new provider that it hasn&rsquo;t seen before (it has a unique ComponentName).</li><li>It registers and stores it inside the <strong>mProviders</strong> variable.</li><li>Then, the service notices that it keeps a reference to a provider that is no longer used (your previous provider). There is no manifest file that declares it so the service decides that it is safe to <strong>remove</strong> it entirely. As part of the provider&rsquo;s removal process, every widget associated with that provider is removed as well.</li><li>You end up with empty widgets on the home screen that are no longer referenced by any component and cannot be updated.</li><li>The only way to get them to work again is to add them to the launcher anew.</li></ol><h3 id=i-am-not-alone>I am not alone<a hidden class=anchor aria-hidden=true href=#i-am-not-alone>¶</a></h3><p>Interestingly, developers working on the Firefox app faced the same problem. If you look at the <a href=https://github.com/mozilla-mobile/fenix/blob/main/app/src/main/java/org/mozilla/gecko/search/SearchWidgetProvider.kt#L35>source code</a> of their class extending AppWidgetProvider, you will find a comment at the top warning against modifying the package name or the class name:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>SearchWidgetProvider</span> <span class=p>:</span> <span class=n>AppWidgetProvider</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Implementation note:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// This class name (SearchWidgetProvider) and package name (org.mozilla.gecko.search) should
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// not be changed because otherwise this widget will disappear from the home screen of the user.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// The existing name replicates the name and package we used in Fennec.
</span></span></span></code></pre></div><h2 id=solution>Solution?<a hidden class=anchor aria-hidden=true href=#solution>¶</a></h2><p>Unfortunately, there is currently no way to solve this problem as the code responsible for this behavior lies beyond our control. The only thing you can do is to make sure not to modify anything related to your widget provider after releasing your app if you don&rsquo;t want your users to lose their existing widgets.</p><p>Honestly, in most cases, it won&rsquo;t be a huge deal. Even though users would have to place those widgets again on their home screen, everything will continue to work as previously. However, if the configuration of widgets in your app is complicated and time-consuming, this can cause a lot of frustration.</p><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>¶</a></h2><p>Once you implement widgets in your app and release it, do not change the package name or class name of your class extending AppWidgetProvider. It will wipe out all of your user&rsquo;s existing widgets and possibly bring a flood of 1-star reviews for your app.</p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://arkadiuszchmura.com/posts/my-key-takeaways-from-the-pragmatic-programmer/><span class=title><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>My key takeaways from The Pragmatic Programmer</span>
</a><a class=next href=https://arkadiuszchmura.com/posts/how-to-reliably-update-widgets-on-android/><span class=title>Next Page&nbsp;<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>How to reliably update widgets on Android</span></a></nav></footer><div class=comments-separator></div><script src=https://utteranc.es/client.js repo=ClouddJR/arkadiuszchmura.com issue-term=pathname label=comments crossorigin=anonymous async></script><script>function updateUtterancesTheme(e){const t=document.querySelector(".utterances-frame");if(t){const n={type:"set-theme",theme:e?"github-light":"github-dark"};t.contentWindow.postMessage(n,"https://utteranc.es")}}function handleMessageEvent(e){if(e.origin!=="https://utteranc.es")return;const t=!document.body.classList.contains("dark");updateUtterancesTheme(t),removeEventListener("message",handleMessageEvent)}addEventListener("message",handleMessageEvent),toggleThemeCallbacks.comments=updateUtterancesTheme</script></article></main><footer class=footer><span></span>
<span>&copy; 2024 <a href=https://arkadiuszchmura.com/>Arkadiusz Chmura</a></span></footer><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script><script>mediumZoom(".entry-cover img"),mediumZoom(".post-content img:not([no-zoom])")</script></body></html>