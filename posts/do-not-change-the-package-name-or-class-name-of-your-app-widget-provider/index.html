<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Do not change the package name or class name of your AppWidgetProvider | Arkadiusz Chmura</title><meta name=keywords content><meta name=description content="If you do this, widgets that were placed on the home screen by your users will simply disappear."><meta name=author content><link rel=canonical href=https://arkadiuszchmura.com/posts/do-not-change-the-package-name-or-class-name-of-your-app-widget-provider/><link crossorigin=anonymous href=/assets/css/stylesheet.min.9ba27e3c8c2747e1cde460076c0ca4266a90ef93999b5f361979f681b9f778a6.css integrity="sha256-m6J+PIwnR+HN5GAHbAykJmqQ75OZm182GXn2gbn3eKY=" rel="preload stylesheet" as=style><link rel=icon href=https://arkadiuszchmura.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://arkadiuszchmura.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://arkadiuszchmura.com/favicon-32x32.png><link rel=apple-touch-icon href=https://arkadiuszchmura.com/apple-touch-icon.png><link rel=mask-icon href=https://arkadiuszchmura.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.99.1"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Do not change the package name or class name of your AppWidgetProvider"><meta property="og:description" content="If you do this, widgets that were placed on the home screen by your users will simply disappear."><meta property="og:type" content="article"><meta property="og:url" content="https://arkadiuszchmura.com/posts/do-not-change-the-package-name-or-class-name-of-your-app-widget-provider/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-22T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-22T00:00:00+00:00"><meta property="og:site_name" content="Arkadiusz Chmura"><meta name=twitter:card content="summary"><meta name=twitter:title content="Do not change the package name or class name of your AppWidgetProvider"><meta name=twitter:description content="If you do this, widgets that were placed on the home screen by your users will simply disappear."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://arkadiuszchmura.com/posts/"},{"@type":"ListItem","position":2,"name":"Do not change the package name or class name of your AppWidgetProvider","item":"https://arkadiuszchmura.com/posts/do-not-change-the-package-name-or-class-name-of-your-app-widget-provider/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Do not change the package name or class name of your AppWidgetProvider","name":"Do not change the package name or class name of your AppWidgetProvider","description":"If you do this, widgets that were placed on the home screen by your users will simply disappear.","keywords":[],"articleBody":"Introduction When creating a widget for your Android app, one of the components that you need to define is a class that extends AppWidgetProvider. Through it, you will receive broadcasts when the widget is updated, enabled, disabled, deleted, resized, etc. You can then act accordingly and, for example, refresh the widget’s view to display the newest data.\nI implemented a widget in one of my apps following the steps mentioned in the documentation and everything was working just fine.\nAt least until one day. After noticing that my app is getting bigger, I decided to change the structure of my app a little to package classes by features rather than by layers.\nWhen I changed the package name of my class extending AppWidgetProvider from\ncom.arkadiusz.Provider.MyAppWidgetProvider to\ncom.arkadiusz.data.providers.MyAppWidgetProvider and relaunched the app, all app’s widgets disappeared from my home screen.\nI can consider myself lucky for noticing this before releasing the next version of the app and causing this problem for all users.\nIt is quite strange that changing a package name of one class can produce such a radical effect so let’s dive into the Android source code and find out why this is happening.\nBehind the scenes In Android, a system service responsible for managing widgets across the entire OS is called AppWidgetService. This is a component that knows, among other things, how and when to update your widgets (based, for example, on the information that you specify in your AppWidgetProviderInfo XML).\nInternally, some of the variables that it holds are as follows:\nprivate final ArrayListWidget mWidgets = new ArrayList(); private final ArrayListHost mHosts = new ArrayList(); private final ArrayListProvider mProviders = new ArrayList();  mWidgets stores references to all widgets that are placed within all hosts. mHosts stores references to all AppWidgetHosts, which are components designed to be used by applications that want to embed widgets in their UI (mostly home screen applications). They provide interaction with the AppWidget service. mProviders stores references to all AppWidgetProviders that were registered by currently installed apps. Each Provider object is identified by a ComponentName (which stores two pieces of information - package name and the class name). It also keeps references to all widgets that it is responsible for.  The AppWidget service also listens for different broadcasts related to application packages (like Intent.ACTION_PACKAGE_ADDED or Intent.ACTION_PACKAGE_REMOVED). It does that to keep its ArrayLists up to date. For example, when a user deletes an app from their device, the service can remove every widget and provider associated with this app because they are no longer needed.\nI mentioned earlier that the service identifies each provider by its ComponentName. Well, if we decide to change the provider’s package name or class name, the new ComponentName is going to be different. This is the root of the problem.\nHere is what happens when you modify your provider’s package name or class name and then update your app:\n The AppWidget service is notified about an application package update via a broadcast. It reads the app’s manifest file and finds a new provider that it hasn’t seen before (it has a unique ComponentName). It registers and stores it inside the mProviders variable. Then, the service notices that it keeps a reference to a provider that is no longer used (your previous provider). There is no manifest file that declares it so the service decides that it is safe to remove it entirely. As part of the provider’s removal process, every widget associated with that provider is removed as well. You end up with empty widgets on the home screen that are no longer referenced by any component and cannot be updated. The only way to get them to work again is to add them to the launcher anew.  I am not alone Interestingly, developers working on the Firefox app faced the same problem. If you look at the source code of their class extending AppWidgetProvider, you will find a comment at the top warning against modifying the package name or the class name:\nclass SearchWidgetProvider : AppWidgetProvider() { \t// Implementation note: \t// This class name (SearchWidgetProvider) and package name (org.mozilla.gecko.search) should \t// not be changed because otherwise this widget will disappear from the home screen of the user. \t// The existing name replicates the name and package we used in Fennec. Solution? Unfortunately, there is currently no way to solve this problem as the code responsible for this behavior lies beyond our control. The only thing you can do is to make sure not to modify anything related to your widget provider after releasing your app if you don’t want your users to lose their existing widgets.\nHonestly, in most cases, it won’t be a huge deal. Even though users would have to place those widgets again on their home screen, everything will continue to work as previously. However, if the configuration of widgets in your app is complicated and time-consuming, this can cause a lot of frustration.\nSummary Once you implement widgets in your app and release it, do not change the package name or class name of your class extending AppWidgetProvider. It will wipe out all of your user’s existing widgets and possibly bring a flood of 1-star reviews for your app.\n","wordCount":"866","inLanguage":"en","datePublished":"2022-02-22T00:00:00Z","dateModified":"2022-02-22T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://arkadiuszchmura.com/posts/do-not-change-the-package-name-or-class-name-of-your-app-widget-provider/"},"publisher":{"@type":"Organization","name":"Arkadiusz Chmura","logo":{"@type":"ImageObject","url":"https://arkadiuszchmura.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://arkadiuszchmura.com/ accesskey=h title="Arkadiusz Chmura (Alt + H)">Arkadiusz Chmura</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://arkadiuszchmura.com/archive title=Archive><span>Archive</span></a></li><li><a href=https://arkadiuszchmura.com/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://arkadiuszchmura.com/>Home</a>&nbsp;»&nbsp;<a href=https://arkadiuszchmura.com/posts/>Posts</a></div><h1 class=post-title>Do not change the package name or class name of your AppWidgetProvider</h1><div class=post-meta><span title="2022-02-22 00:00:00 +0000 UTC">February 22, 2022</span>&nbsp;·&nbsp;5 min</div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>When creating a widget for your Android app, one of the components that you need to define is a class that extends <a href=https://developer.android.com/reference/android/appwidget/AppWidgetProvider>AppWidgetProvider</a>. Through it, you will receive broadcasts when the widget is updated, enabled, disabled, deleted, resized, etc. You can then act accordingly and, for example, refresh the widget&rsquo;s view to display the newest data.</p><p>I implemented a widget in <a href="https://play.google.com/store/apps/details?id=com.arkadiusz.dayscounter">one of my apps</a> following the steps mentioned <a href=https://developer.android.com/guide/topics/appwidgets>in the documentation</a> and everything was working just fine.</p><p>At least until one day. After noticing that my app is getting bigger, I decided to change the structure of my app a little to package classes by features rather than by layers.</p><p>When I changed the package name of my class extending AppWidgetProvider from</p><pre tabindex=0><code>com.arkadiusz.Provider.MyAppWidgetProvider
</code></pre><p>to</p><pre tabindex=0><code>com.arkadiusz.data.providers.MyAppWidgetProvider
</code></pre><p>and relaunched the app, all app&rsquo;s widgets disappeared from my home screen.</p><p>I can consider myself lucky for noticing this before releasing the next version of the app and causing this problem for all users.</p><p>It is quite strange that changing a package name of one class can produce such a radical effect so let&rsquo;s dive into the Android source code and find out why this is happening.</p><h2 id=behind-the-scenes>Behind the scenes<a hidden class=anchor aria-hidden=true href=#behind-the-scenes>#</a></h2><p>In Android, a system service responsible for managing widgets across the entire OS is called <a href=https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/appwidget/java/com/android/server/appwidget/AppWidgetServiceImpl.java>AppWidgetService</a>. This is a component that knows, among other things, <strong>how</strong> and <strong>when</strong> to update your widgets (based, for example, on the information that you specify in your AppWidgetProviderInfo XML).</p><p>Internally, some of the variables that it holds are as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> ArrayList<span style=color:#ff79c6>&lt;</span>Widget<span style=color:#ff79c6>&gt;</span> mWidgets <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>  
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> ArrayList<span style=color:#ff79c6>&lt;</span>Host<span style=color:#ff79c6>&gt;</span> mHosts <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>  
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> ArrayList<span style=color:#ff79c6>&lt;</span>Provider<span style=color:#ff79c6>&gt;</span> mProviders <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span></code></pre></div><ul><li><strong>mWidgets</strong> stores references to all widgets that are placed within all hosts.</li><li><strong>mHosts</strong> stores references to all <a href=https://developer.android.com/reference/android/appwidget/AppWidgetHost>AppWidgetHosts</a>, which are components designed to be used by applications that want to embed widgets in their UI (mostly home screen applications). They provide interaction with the AppWidget service.</li><li><strong>mProviders</strong> stores references to all AppWidgetProviders that were registered by currently installed apps. Each Provider object is identified by a <a href=https://developer.android.com/reference/android/content/ComponentName>ComponentName</a> (which stores two pieces of information - package name and the class name). It also keeps references to all widgets that it is responsible for.</li></ul><p>The AppWidget service also listens for different broadcasts related to application packages (like <code>Intent.ACTION_PACKAGE_ADDED</code> or <code>Intent.ACTION_PACKAGE_REMOVED</code>). It does that to keep its ArrayLists up to date. For example, when a user deletes an app from their device, the service can remove every widget and provider associated with this app because they are no longer needed.</p><p>I mentioned earlier that the service identifies each provider by its ComponentName. Well, if we decide to change the provider&rsquo;s package name or class name, the new ComponentName is going to be <strong>different</strong>. This is the root of the problem.</p><p>Here is what happens when you modify your provider&rsquo;s package name or class name and then update your app:</p><ol><li>The AppWidget service is notified about an application package update via a broadcast.</li><li>It reads the app&rsquo;s manifest file and finds a new provider that it hasn&rsquo;t seen before (it has a unique ComponentName).</li><li>It registers and stores it inside the <strong>mProviders</strong> variable.</li><li>Then, the service notices that it keeps a reference to a provider that is no longer used (your previous provider). There is no manifest file that declares it so the service decides that it is safe to <strong>remove</strong> it entirely. As part of the provider&rsquo;s removal process, every widget associated with that provider is removed as well.</li><li>You end up with empty widgets on the home screen that are no longer referenced by any component and cannot be updated.</li><li>The only way to get them to work again is to add them to the launcher anew.</li></ol><h3 id=i-am-not-alone>I am not alone<a hidden class=anchor aria-hidden=true href=#i-am-not-alone>#</a></h3><p>Interestingly, developers working on the Firefox app faced the same problem. If you look at the <a href=https://github.com/mozilla-mobile/fenix/blob/main/app/src/main/java/org/mozilla/gecko/search/SearchWidgetProvider.kt#L35>source code</a> of their class extending AppWidgetProvider, you will find a comment at the top warning against modifying the package name or the class name:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>SearchWidgetProvider</span> : AppWidgetProvider() {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Implementation note:
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#6272a4>// This class name (SearchWidgetProvider) and package name (org.mozilla.gecko.search) should
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#6272a4>// not be changed because otherwise this widget will disappear from the home screen of the user.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#6272a4>// The existing name replicates the name and package we used in Fennec.
</span></span></span></code></pre></div><h2 id=solution>Solution?<a hidden class=anchor aria-hidden=true href=#solution>#</a></h2><p>Unfortunately, there is currently no way to solve this problem as the code responsible for this behavior lies beyond our control. The only thing you can do is to make sure not to modify anything related to your widget provider after releasing your app if you don&rsquo;t want your users to lose their existing widgets.</p><p>Honestly, in most cases, it won&rsquo;t be a huge deal. Even though users would have to place those widgets again on their home screen, everything will continue to work as previously. However, if the configuration of widgets in your app is complicated and time-consuming, this can cause a lot of frustration.</p><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><p>Once you implement widgets in your app and release it, do not change the package name or class name of your class extending AppWidgetProvider. It will wipe out all of your user&rsquo;s existing widgets and possibly bring a flood of 1-star reviews for your app.</p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://arkadiuszchmura.com/posts/my-key-takeaways-from-the-pragmatic-programmer/><span class=title>« Prev Page</span><br><span>My key takeaways from The Pragmatic Programmer</span></a>
<a class=next href=https://arkadiuszchmura.com/posts/how-to-reliably-update-widgets-on-android/><span class=title>Next Page »</span><br><span>How to reliably update widgets on Android</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://arkadiuszchmura.com/>Arkadiusz Chmura</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>