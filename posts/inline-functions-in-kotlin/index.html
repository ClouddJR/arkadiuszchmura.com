<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Inline functions in Kotlin | Arkadiusz Chmura</title>
<meta name=keywords content><meta name=description content="A comprehensive guide to inline functions, covering their purpose, practical examples, and tips for when to use or avoid them."><meta name=author content><link rel=canonical href=https://arkadiuszchmura.com/posts/inline-functions-in-kotlin/><link crossorigin=anonymous href=/assets/css/stylesheet.min.2a98b1550cccc65faf3cf4916bdbf4af464fffd9915ac511833ff1fe2426ad22.css integrity="sha256-KpixVQzMxl+vPPSRa9v0r0ZP/9mRWsURgz/x/iQmrSI=" rel="preload stylesheet" as=style><link rel=icon href=https://arkadiuszchmura.com/favicon.ico><link rel=apple-touch-icon href=https://arkadiuszchmura.com/apple-touch-icon.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-9BS720SLJB"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9BS720SLJB",{anonymize_ip:!1})}</script><meta name=twitter:title content="Inline functions in Kotlin | Arkadiusz Chmura"><meta name=twitter:description content="A comprehensive guide to inline functions, covering their purpose, practical examples, and tips for when to use or avoid them."><meta property="og:title" content="Inline functions in Kotlin | Arkadiusz Chmura"><meta property="og:description" content="A comprehensive guide to inline functions, covering their purpose, practical examples, and tips for when to use or avoid them."><meta property="og:type" content="article"><meta property="og:url" content="https://arkadiuszchmura.com/posts/inline-functions-in-kotlin/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-23T00:00:00+00:00"><meta property="og:site_name" content="Arkadiusz Chmura"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://arkadiuszchmura.com/posts/"},{"@type":"ListItem","position":2,"name":"Inline functions in Kotlin","item":"https://arkadiuszchmura.com/posts/inline-functions-in-kotlin/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Inline functions in Kotlin | Arkadiusz Chmura","name":"Inline functions in Kotlin","description":"A comprehensive guide to inline functions, covering their purpose, practical examples, and tips for when to use or avoid them.","keywords":[],"wordCount":"2212","inLanguage":"en","datePublished":"2023-02-23T00:00:00Z","dateModified":"2023-02-23T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://arkadiuszchmura.com/posts/inline-functions-in-kotlin/"},"publisher":{"@type":"Organization","name":"Arkadiusz Chmura","logo":{"@type":"ImageObject","url":"https://arkadiuszchmura.com/favicon.ico"}}}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel=stylesheet><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://arkadiuszchmura.com/ accesskey=h title="Arkadiusz Chmura (Alt + H)">Arkadiusz Chmura</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://arkadiuszchmura.com/archive/ title=Archive>Archive</a></li><li><a href=https://arkadiuszchmura.com/search/ title="Search (Alt + /)" data-no-instant accesskey=/>Search</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://arkadiuszchmura.com/>Home</a>&nbsp;»&nbsp;<a href=https://arkadiuszchmura.com/posts/>Posts</a></div><h1 class=post-title>Inline functions in Kotlin</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>February 23, 2023</span></span><span class=meta-item>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>11 min</span></span></div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>¶</a></h2><p>In this post, I would like to explain in detail what inline functions are and what problems they address. Additionally, I will present some practical examples and tips on when it&rsquo;s appropriate to use inline functions and when to avoid them.</p><p>Before we go any further, let&rsquo;s first understand what inline functions do. The general idea is simple. If you mark a function with the <code>inline</code> modifier, the compiler will copy the body of that function and paste it at every call site.</p><p>As a result, this code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>inline</span> <span class=k>fun</span> <span class=nf>foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;Body of the foo() function&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>foo</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>after compilation will be ultimately equivalent to this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>inline</span> <span class=k>fun</span> <span class=nf>foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;Body of the foo() function&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;Body of the foo() function&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>What happened here is instead of calling <code>foo()</code>, the compiler copied its content and pasted it into the body of the <code>main()</code> function.</p><p>Now that we have a basic intuition for inline functions, we can move on to discuss their applications.</p><h2 id=overhead-of-lambdas-and-anonymous-functions>Overhead of lambdas and anonymous functions<a hidden class=anchor aria-hidden=true href=#overhead-of-lambdas-and-anonymous-functions>¶</a></h2><p>In Kotlin, functions are <a href=https://en.wikipedia.org/wiki/First-class_function>first-class citizens</a>. They can be stored in variables or data structures, used as arguments, or returned from other functions. However, this feature has an important implication. Functions in these scenarios are represented as objects, which impose certain runtime penalties.</p><p>Let&rsquo;s illustrate this with an example. Suppose we write a function called <code>takeUntil</code> (which is surprisingly not in the standard library) that would take all the elements from an iterable until a provided predicate is satisfied.</p><p>This is what it could look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=p>&lt;</span><span class=nc>T</span><span class=p>&gt;</span> <span class=nf>Iterable</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;.</span><span class=n>takeUntil</span><span class=p>(</span><span class=n>predicate</span><span class=p>:</span> <span class=p>(</span><span class=n>T</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Boolean</span><span class=p>):</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>list</span> <span class=p>=</span> <span class=n>ArrayList</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;()</span>  
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>item</span> <span class=k>in</span> <span class=k>this</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>list</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>predicate</span><span class=p>(</span><span class=n>item</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>            <span class=k>break</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>list</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We define it as an extension function and specify one argument, <code>predicate</code>, which is a function that will control when we stop taking elements.</p><blockquote><p>In Kotlin, functions that take other functions as parameters, or return a function, are called High-order functions.</p></blockquote><p>Let&rsquo;s see what the decompiled bytecode for this function looks like in Java:</p><blockquote><p>In IntelliJ (or Android Studio), you can get the decompiled bytecode by going to <code>Tools</code> > <code>Kotlin</code> > <code>Show Kotlin Bytecode</code> and then clicking <code>Decompile</code> button to get the Java code.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>takeUntil</span><span class=p>(</span><span class=nd>@NotNull</span><span class=w> </span><span class=n>Iterable</span><span class=w> </span><span class=n>$this$takeUntil</span><span class=p>,</span><span class=w> </span><span class=nd>@NotNull</span><span class=w> </span><span class=n>Function1</span><span class=w> </span><span class=n>predicate</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>Notice that our <code>predicate</code> argument has a special <code>Function1</code> type (this <code>1</code> in <code>Function1</code> corresponds to the number of arguments our lambda accepts), which confirms that lambdas are indeed represented as objects. We must provide an instance of the <code>Function1</code> interface every time we call the <code>takeUntil</code> function.</p><p>Now, let&rsquo;s write some code to test our new function and see how lambdas that we pass to the <code>takeUntil</code> function are converted to objects of the <code>Function1</code> type under the hood:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>numbers</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>3</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>5</span><span class=p>,</span> <span class=m>6</span><span class=p>,</span> <span class=m>7</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>numbers</span><span class=p>.</span><span class=n>takeUntil</span> <span class=p>{</span> <span class=k>it</span> <span class=o>&gt;=</span> <span class=m>5</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>When executed, this code prints a correct result (a list of numbers from 1 to 5 included), but we&rsquo;re interested in something else here. Let&rsquo;s see the decompiled version of the code above:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=w> </span><span class=n>numbers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CollectionsKt</span><span class=p>.</span><span class=na>listOf</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Integer</span><span class=o>[]</span><span class=p>{</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>4</span><span class=p>,</span><span class=w> </span><span class=n>5</span><span class=p>,</span><span class=w> </span><span class=n>6</span><span class=p>,</span><span class=w> </span><span class=n>7</span><span class=p>});</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>takeUntil</span><span class=p>((</span><span class=n>Iterable</span><span class=p>)</span><span class=n>numbers</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>Function1</span><span class=p>)</span><span class=kc>null</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>As you can see, the <code>takeUntil</code> function takes a mysterious <code>(Function1)null.INSTANCE</code> object as an argument. Where does it come from?</p><p>Unfortunately, the generated <code>Function1</code> interface doesn&rsquo;t reflect in the decompiled Java code, so we must dive deeper - into the bytecode itself.</p><p>I will skip all the irrelevant code for our discussion and present only the interesting parts.</p><p>First, we can see a class created that implements the <code>Function1</code> interface.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>MainKt$main$1</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>kotlin</span><span class=o>/</span><span class=n>jvm</span><span class=o>/</span><span class=n>internal</span><span class=o>/</span><span class=n>Lambda</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>kotlin</span><span class=o>/</span><span class=n>jvm</span><span class=o>/</span><span class=n>functions</span><span class=o>/</span><span class=n>Function1</span><span class=w>
</span></span></span></code></pre></div><p>The bytecode for that class is equivalent to the lambda body that we&rsquo;ve passed to the <code>takeUntil</code> function.</p><p>Our <code>main()</code> function is represented like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>GETSTATIC</span> <span class=n>MainKt</span><span class=err>$</span><span class=n>main</span><span class=err>$</span><span class=m>1.</span><span class=n>INSTANCE</span> <span class=p>:</span> <span class=n>LMainKt</span><span class=err>$</span><span class=n>main</span><span class=err>$</span><span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>CHECKCAST</span> <span class=n>kotlin</span><span class=p>/</span><span class=n>jvm</span><span class=p>/</span><span class=n>functions</span><span class=p>/</span><span class=n>Function1</span>
</span></span><span class=line><span class=cl><span class=n>INVOKESTATIC</span> <span class=nc>MainKt</span><span class=p>.</span><span class=n>takeUntil</span> <span class=p>(</span><span class=n>Ljava</span><span class=p>/</span><span class=n>lang</span><span class=p>/</span><span class=n>Iterable</span><span class=p>;</span><span class=n>Lkotlin</span><span class=p>/</span><span class=n>jvm</span><span class=p>/</span><span class=n>functions</span><span class=p>/</span><span class=n>Function1</span><span class=p>;)</span><span class=n>Ljava</span><span class=p>/</span><span class=n>util</span><span class=p>/</span><span class=n>List</span><span class=p>;</span>
</span></span></code></pre></div><p>The <code>GETSTATIC</code> <a href=https://en.wikipedia.org/wiki/List_of_Java_bytecode_instructions>instruction</a> gets a class&rsquo;s static field value, which means we get a singleton here that is ultimately passed to the <code>takeUntil</code> function.</p><p>Let&rsquo;s do a quick experiment to confirm that if we put our code in a loop that runs 1000 times, we still use that singleton, and we don&rsquo;t create 1000 new objects:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>numbers</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>3</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>5</span><span class=p>,</span> <span class=m>6</span><span class=p>,</span> <span class=m>7</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=n>repeat</span><span class=p>(</span><span class=m>1000</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>numbers</span><span class=p>.</span><span class=n>takeUntil</span> <span class=p>{</span> <span class=k>it</span> <span class=o>&gt;=</span> <span class=m>5</span> <span class=p>})</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>After getting the bytecode, we can confirm that the <code>GETSTATIC</code> instruction is still used, so no new objects are being created.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>GETSTATIC</span> <span class=n>MainKt</span><span class=err>$</span><span class=n>main</span><span class=err>$</span><span class=m>1</span><span class=err>$</span><span class=m>1.</span><span class=n>INSTANCE</span> <span class=p>:</span> <span class=n>LMainKt</span><span class=err>$</span><span class=n>main</span><span class=err>$</span><span class=m>1</span><span class=err>$</span><span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>CHECKCAST</span> <span class=n>kotlin</span><span class=p>/</span><span class=n>jvm</span><span class=p>/</span><span class=n>functions</span><span class=p>/</span><span class=n>Function1</span>
</span></span><span class=line><span class=cl><span class=n>INVOKESTATIC</span> <span class=nc>MainKt</span><span class=p>.</span><span class=n>takeUntil</span> <span class=p>(</span><span class=n>Ljava</span><span class=p>/</span><span class=n>lang</span><span class=p>/</span><span class=n>Iterable</span><span class=p>;</span><span class=n>Lkotlin</span><span class=p>/</span><span class=n>jvm</span><span class=p>/</span><span class=n>functions</span><span class=p>/</span><span class=n>Function1</span><span class=p>;)</span><span class=n>Ljava</span><span class=p>/</span><span class=n>util</span><span class=p>/</span><span class=n>List</span><span class=p>;</span>
</span></span></code></pre></div><p>So far, nothing dramatic. The bytecode contains an additional class implementing the <code>Function1</code> interface that represents our lambda passed to the <code>takeUntil</code> function. Additionally, a singleton was used, so there is only one instance of that class at runtime.</p><p>However, the situation is <strong>entirely different</strong> when we start capturing variables in lambdas.</p><p>Let&rsquo;s store the value we had in the lambda in a variable called <code>limit</code> and use it instead:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>limit</span> <span class=p>=</span> <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>numbers</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>3</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>5</span><span class=p>,</span> <span class=m>6</span><span class=p>,</span> <span class=m>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>repeat</span><span class=p>(</span><span class=m>1000</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>numbers</span><span class=p>.</span><span class=n>takeUntil</span> <span class=p>{</span> <span class=k>it</span> <span class=o>&gt;=</span> <span class=n>limit</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And here&rsquo;s the bytecode representation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>INVOKESPECIAL</span> <span class=n>MainKt</span><span class=err>$</span><span class=n>main</span><span class=err>$</span><span class=m>1</span><span class=err>$</span><span class=m>1.</span><span class=p>&lt;</span><span class=k>init</span><span class=p>&gt;</span> <span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>V</span>
</span></span><span class=line><span class=cl><span class=n>CHECKCAST</span> <span class=n>kotlin</span><span class=p>/</span><span class=n>jvm</span><span class=p>/</span><span class=n>functions</span><span class=p>/</span><span class=n>Function1</span>
</span></span><span class=line><span class=cl><span class=n>INVOKESTATIC</span> <span class=nc>MainKt</span><span class=p>.</span><span class=n>takeUntil</span> <span class=p>(</span><span class=n>Ljava</span><span class=p>/</span><span class=n>lang</span><span class=p>/</span><span class=n>Iterable</span><span class=p>;</span><span class=n>Lkotlin</span><span class=p>/</span><span class=n>jvm</span><span class=p>/</span><span class=n>functions</span><span class=p>/</span><span class=n>Function1</span><span class=p>;)</span><span class=n>Ljava</span><span class=p>/</span><span class=n>util</span><span class=p>/</span><span class=n>List</span><span class=p>;</span>
</span></span></code></pre></div><p>As you can see, there is no <code>GETSTATIC</code> instruction anymore. Instead, there is <code>INVOKESPECIAL</code> that calls <code>&lt;init></code>. This line means we are creating a new object of that class. Given that we run this code 1000 times, the same number of new objects will be created at this point.</p><p>It&rsquo;s worth remembering that when we create lambdas that capture closures, there will <strong>always</strong> be a new object created, as the above experiment proved. However, in most cases, that won&rsquo;t be a huge problem (unless you deal with a performance-critical application).</p><p>Regardless, the solution is to use inline functions. When we mark our <code>takeUntil</code> function as <code>inline</code>, this is the decompiled Java code that we get for the <code>main()</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=w> </span><span class=n>numbers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CollectionsKt</span><span class=p>.</span><span class=na>listOf</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Integer</span><span class=o>[]</span><span class=p>{</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>4</span><span class=p>,</span><span class=w> </span><span class=n>5</span><span class=p>,</span><span class=w> </span><span class=n>6</span><span class=p>,</span><span class=w> </span><span class=n>7</span><span class=p>});</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>limit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>short</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>var2</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>var3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kt>int</span><span class=w> </span><span class=n>var5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>Iterable</span><span class=w> </span><span class=n>$this$takeUntil$iv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Iterable</span><span class=p>)</span><span class=n>numbers</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kt>int</span><span class=w> </span><span class=n>$i$f$takeUntil</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>ArrayList</span><span class=w> </span><span class=n>list$iv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>Iterator</span><span class=w> </span><span class=n>var9</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>$this$takeUntil$iv</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>while</span><span class=p>(</span><span class=n>var9</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Object</span><span class=w> </span><span class=n>item$iv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var9</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>list$iv</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>item$iv</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>Number</span><span class=p>)</span><span class=n>item$iv</span><span class=p>).</span><span class=na>intValue</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>var12</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>it</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>limit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>break</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>List</span><span class=w> </span><span class=n>var13</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>List</span><span class=p>)</span><span class=n>list$iv</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>var13</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>The content of the <code>takeUntil</code> function has been copied (inlined) here. Our lambda is no longer represented as an object, so we avoid an additional overhead. Instead, it&rsquo;s been inlined into the if statement (<code>if (it >= limit)</code>).</p><h2 id=better-control-flow>Better control flow<a hidden class=anchor aria-hidden=true href=#better-control-flow>¶</a></h2><p>Another benefit of using inline functions is introducing a better control flow.</p><p>Let&rsquo;s consider a function that is supposed to find a user with a given id or throw an error when there is no such user:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=nf>getUser</span><span class=p>(</span><span class=n>users</span><span class=p>:</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>User</span><span class=p>&gt;,</span> <span class=n>id</span><span class=p>:</span> <span class=n>String</span><span class=p>):</span> <span class=n>User</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>users</span><span class=p>.</span><span class=n>forEach</span> <span class=p>{</span> <span class=n>user</span> <span class=o>-&gt;</span>  
</span></span><span class=line><span class=cl>        <span class=n>print</span><span class=p>(</span><span class=s2>&#34;Inspecting user: </span><span class=si>$user</span><span class=s2>&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>user</span><span class=p>.</span><span class=n>id</span> <span class=o>==</span> <span class=n>id</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>user</span>  
</span></span><span class=line><span class=cl>        <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=n>error</span><span class=p>(</span><span class=s2>&#34;User with id </span><span class=si>$id</span><span class=s2> not found.&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We iterate over the list of users and check if the current user is the one we seek. If it is, we immediately return that user from our <code>getUser</code> function. If we reach the end of the list, we throw an error.</p><p>Notice that we use a <code>return</code> statement not inside the <code>getUsers</code> function but in a lambda passed to the <code>forEach</code>. This is only possible because the <code>forEach</code> function has been marked with the <code>inline</code> modifier.</p><blockquote><p>Such returns (located in a lambda, but exiting the enclosing function) are called <em>non-local</em> returns.</p></blockquote><p>If we write our own version of <code>forEach</code> that is not inlined and use it instead, returning from a lambda won&rsquo;t be possible:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=c1>// This is the same function as forEach, but without the inline modifier
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fun</span> <span class=p>&lt;</span><span class=nc>T</span><span class=p>&gt;</span> <span class=nf>Iterable</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;.</span><span class=n>noInlineForEach</span><span class=p>(</span><span class=n>action</span><span class=p>:</span> <span class=p>(</span><span class=n>T</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Unit</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>element</span> <span class=k>in</span> <span class=k>this</span><span class=p>)</span> <span class=n>action</span><span class=p>(</span><span class=n>element</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=nf>getUser</span><span class=p>(</span><span class=n>users</span><span class=p>:</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>User</span><span class=p>&gt;,</span> <span class=n>id</span><span class=p>:</span> <span class=n>String</span><span class=p>):</span> <span class=n>User</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>users</span><span class=p>.</span><span class=n>noInlineForEach</span> <span class=p>{</span> <span class=n>user</span> <span class=o>-&gt;</span>  
</span></span><span class=line><span class=cl>        <span class=n>print</span><span class=p>(</span><span class=s2>&#34;Inspecting user: </span><span class=si>$user</span><span class=s2>&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>user</span><span class=p>.</span><span class=n>id</span> <span class=o>==</span> <span class=n>id</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>user</span>  
</span></span><span class=line><span class=cl>        <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=n>error</span><span class=p>(</span><span class=s2>&#34;User with id </span><span class=si>$id</span><span class=s2> not found.&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We are getting an error that says &ldquo;&lsquo;return&rsquo; is not allowed here&rdquo;.</p><p>The reason why returning with the regular <code>forEach</code> is possible is that when a lambda is inlined, it&rsquo;s clear that the <code>return</code> statement applies to the top-level function (<code>getUsers</code>) because there are no other function calls made or objects created.</p><h2 id=noinline>Noinline<a hidden class=anchor aria-hidden=true href=#noinline>¶</a></h2><p>If you don&rsquo;t want all of the lambdas passed to an inline function to be inlined, you can use the <code>noinline</code> modifier.</p><p>Consider the following inline function <code>execute</code> that decides which API to call based on whether the user is part of an experiment or not:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>inline</span> <span class=k>fun</span> <span class=nf>execute</span><span class=p>(</span>  
</span></span><span class=line><span class=cl>    <span class=n>isPartOfExperiment</span><span class=p>:</span> <span class=p>(</span><span class=n>User</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Boolean</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>    <span class=n>callOldApi</span><span class=p>:</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>Unit</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>    <span class=n>callNewApi</span><span class=p>:</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>Unit</span>  
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=py>callApi</span> <span class=p>=</span> <span class=k>if</span><span class=p>(</span><span class=n>isPartOfExperiment</span><span class=p>(</span><span class=n>user</span><span class=p>))</span> <span class=n>callNewApi</span> <span class=k>else</span> <span class=n>callOldApi</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>We want to store the correct lambda in a variable called <code>callApi</code> and call it later at some point, but that&rsquo;s not possible. We get the &ldquo;Illegal usage of inline-parameter&rdquo; error. We can&rsquo;t store inlined lambdas in variables (or pass them to other functions) because they aren&rsquo;t objects anymore.</p><p>To solve this, we can add <code>noinline</code> modifiers to two of our lambdas, and our code compiles successfully:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>inline</span> <span class=k>fun</span> <span class=nf>execute</span><span class=p>(</span>  
</span></span><span class=line><span class=cl>    <span class=n>isPartOfExperiment</span><span class=p>:</span> <span class=p>(</span><span class=n>User</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Boolean</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>    <span class=k>noinline</span> <span class=n>callOldApi</span><span class=p>:</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>Unit</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>    <span class=k>noinline</span> <span class=n>callNewApi</span><span class=p>:</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>Unit</span>  
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=py>callApi</span> <span class=p>=</span> <span class=k>if</span><span class=p>(</span><span class=n>isPartOfExperiment</span><span class=p>(</span><span class=n>user</span><span class=p>))</span> <span class=n>callNewApi</span> <span class=k>else</span> <span class=n>callOldApi</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><h2 id=crossinline>Crossinline<a hidden class=anchor aria-hidden=true href=#crossinline>¶</a></h2><p>In some cases, we still want to get all the benefits of using inline functions but without giving the possibility to use a <code>return</code> statement inside lambdas passed as parameters.</p><p>To indicate that the lambda parameter of the inline function cannot use non-local returns, we can mark it with the <code>crossinline</code> modifier.</p><p>Take a look at our little helper <code>benchmark</code> function that allows us to measure the execution time of a lambda passed as a parameter:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>inline</span> <span class=k>fun</span> <span class=nf>benchmark</span><span class=p>(</span><span class=n>run</span><span class=p>:</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>Unit</span><span class=p>):</span> <span class=n>Long</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>duration</span> <span class=p>=</span> <span class=n>measureTime</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>run</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>duration</span><span class=p>.</span><span class=n>inWholeMilliseconds</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now, for a little experiment, let&rsquo;s try to run the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>time</span> <span class=p>=</span> <span class=n>benchmark</span> <span class=p>{</span> <span class=k>return</span> <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=n>time</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It compiles successfully because the <code>benchmark</code> function is marked with the <code>inline</code> modifier, and using non-local returns is possible in such cases.</p><p>If we run it, the console won&rsquo;t print anything. That&rsquo;s because the <code>return</code> statement returns not from the <code>benchmark</code> function but immediately from the <code>main()</code>, thus ending the program.</p><p>If we don&rsquo;t want to allow code like this, we can use the <code>crossinline</code> modifier, and the <code>main()</code> function won&rsquo;t even compile. We will get the &ldquo;&lsquo;return&rsquo; is not allowed here&rdquo; error:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>inline</span> <span class=k>fun</span> <span class=nf>benchmark</span><span class=p>(</span><span class=k>crossinline</span> <span class=n>run</span><span class=p>:</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>Unit</span><span class=p>):</span> <span class=n>Long</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>duration</span> <span class=p>=</span> <span class=n>measureTime</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>run</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>duration</span><span class=p>.</span><span class=n>inWholeMilliseconds</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=reified-types>Reified types<a hidden class=anchor aria-hidden=true href=#reified-types>¶</a></h2><p>Imagine we want to write a function that will return the first item of a given type from a list. For example, we have a <code>listOf(1, 2, "string", 3)</code> and would like to get the first string from that list.</p><p>Here&rsquo;s one approach to writing such a function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=p>&lt;</span><span class=nc>T</span><span class=p>&gt;</span> <span class=nf>List</span><span class=p>&lt;*&gt;.</span><span class=n>firstIsInstance</span><span class=p>(</span><span class=n>clazz</span><span class=p>:</span> <span class=n>Class</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;):</span> <span class=n>T</span><span class=p>?</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=nd>@Suppress</span><span class=p>(</span><span class=s2>&#34;UNCHECKED_CAST&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>firstOrNull</span> <span class=p>{</span> <span class=n>clazz</span><span class=p>.</span><span class=n>isInstance</span><span class=p>(</span><span class=k>it</span><span class=p>)</span> <span class=p>}</span> <span class=k>as</span> <span class=n>T</span><span class=p>?</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And that&rsquo;s what the code to use this function could look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>items</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=m>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>println</span><span class=p>(</span><span class=n>items</span><span class=p>.</span><span class=n>firstIsInstance</span><span class=p>(</span><span class=n>String</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>))</span>  
</span></span></code></pre></div><p>This code works, but it’s not pretty. We have to pass that not-so-beautiful <code>String::class.java</code> to the function.</p><p>Additionally, inside, we have to use a suppression mechanism and call the parameter <code>clazz</code>, because <code>class</code> is a reserved keyword. A lot of compromises.</p><p>As an alternative, we can rewrite the <code>firstIsInstance</code> function as an inline version and utilize <em>reified type parameters</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>inline</span> <span class=k>fun</span> <span class=p>&lt;</span><span class=k>reified</span> <span class=nc>T</span><span class=p>&gt;</span> <span class=nf>List</span><span class=p>&lt;*&gt;.</span><span class=n>firstIsInstance</span><span class=p>():</span> <span class=n>T</span><span class=p>?</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>firstOrNull</span> <span class=p>{</span> <span class=k>it</span> <span class=k>is</span> <span class=n>T</span> <span class=p>}</span> <span class=k>as</span> <span class=n>T</span><span class=p>?</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Marking the type parameter with the <code>reified</code> modifier makes it accessible inside the function. Also, because the function is inlined, we can use normal operators like <code>as</code> or <code>is</code>, without relying on reflection.</p><p>With that change, the client code looks much more elegant:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>items</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=m>3</span><span class=p>)</span>   
</span></span><span class=line><span class=cl><span class=n>println</span><span class=p>(</span><span class=n>items</span><span class=p>.</span><span class=n>firstIsInstance</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;())</span>
</span></span></code></pre></div><h2 id=avoiding-inline-functions>Avoiding inline functions<a hidden class=anchor aria-hidden=true href=#avoiding-inline-functions>¶</a></h2><p>So far, we&rsquo;ve discussed the benefits of using inline functions. However, it&rsquo;s also worth mentioning when it would be better to avoid them.</p><p>First, it doesn&rsquo;t make much sense to add the <code>inline</code> modifier to a function that doesn&rsquo;t have any lambdas as parameters because the performance gains are unlikely. The JVM already optimizes small functions and inline them automatically.</p><p>Furthermore, you can&rsquo;t use inline functions when hiding implementation details (public inline functions can&rsquo;t call private functions):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>inline</span> <span class=k>fun</span> <span class=nf>doSomething</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>doSomethingPrivately</span><span class=p>()</span> <span class=c1>// Won&#39;t compile.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>doSomethingPrivately</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;Private function&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>After learning about the benefits of inline functions, it might be tempting to use them everywhere now but resist the temptation.</p><p>For example, inlining a large function could dramatically increase the size of the generated bytecode because it&rsquo;s copied to every call site. For similar reasons, it&rsquo;s better to avoid inlining recursive calls.</p><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>¶</a></h2><p>This was quite a long post, but I hope you learned a lot from it. As much as I love the <a href=https://kotlinlang.org/docs/home.html>Kotlin documentation</a>, I think the section dedicated to inline functions could use some work. That was the main motivation behind the decision to cover inline functions extensively here, including some practical examples.</p><p>If you have any questions, feel free to leave a comment here or reach out to me on <a href=https://twitter.com/ClouddJR/>Twitter</a>.</p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://arkadiuszchmura.com/posts/how-to-create-factories-for-models-with-polymorphic-relationships-in-laravel/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>How to create factories for models with polymorphic relationships in Laravel</span>
</a><a class=next href=https://arkadiuszchmura.com/posts/how-to-fix-the-invalid-jdk-problem-on-electric-eel/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>How to fix the invalid JDK problem on Electric Eel</span></a></nav></footer><div class=newsletter><h2 class=header>Subscribe to my newsletter.</h2><p class=prompt>Enjoyed this post? Subscribe to be notified about my new blog posts that I consider worth sharing.</p><form action=https://tinyletter.com/cloudjr method=post target=popupwindow onsubmit='return window.open("https://tinyletter.com/cloudjr","popupwindow","scrollbars=yes,width=800,height=600"),!0'><label for=email-address class=sr-only>Email address</label>
<input id=email-address name=email type=email autocomplete=email required placeholder="Enter your email">
<button type=submit>Subscribe</button></form></div><script src=https://utteranc.es/client.js repo=ClouddJR/arkadiuszchmura.com issue-term=pathname label=comments crossorigin=anonymous async></script><script>function updateUtterancesTheme(e){const t=document.querySelector(".utterances-frame");if(t){const n={type:"set-theme",theme:e?"github-light":"github-dark"};t.contentWindow.postMessage(n,"https://utteranc.es")}}function handleMessageEvent(e){if(e.origin!=="https://utteranc.es")return;const t=!document.body.classList.contains("dark");updateUtterancesTheme(t),removeEventListener("message",handleMessageEvent)}addEventListener("message",handleMessageEvent),toggleThemeCallbacks.comments=updateUtterancesTheme</script></article></main><footer class=footer><span></span>
<span>&copy; 2023 <a href=https://arkadiuszchmura.com/>Arkadiusz Chmura</a></span></footer><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script><script>mediumZoom(".entry-cover img"),mediumZoom(".post-content img:not([no-zoom])")</script></body></html>