<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How ViewModels survive configuration changes | Arkadiusz Chmura</title><meta name=keywords content><meta name=description content="Let&rsquo;s explore their implementation details to see how they achieve this."><meta name=author content><link rel=canonical href=https://arkadiuszchmura.com/posts/how-viewmodels-survive-configuration-changes/><link crossorigin=anonymous href=/assets/css/stylesheet.min.fae4cfc4834f76ac6cce4ff8a96ca6d74c7182c0266a365ff62637f339447878.css integrity="sha256-+uTPxINPdqxszk/4qWym10xxgsAmajZf9iY38zlEeHg=" rel="preload stylesheet" as=style><link rel=icon href=https://arkadiuszchmura.com/favicon.ico><link rel=apple-touch-icon href=https://arkadiuszchmura.com/apple-touch-icon.png><meta name=twitter:title content="How ViewModels survive configuration changes | Arkadiusz Chmura"><meta name=twitter:description content="Let&rsquo;s explore their implementation details to see how they achieve this."><meta property="og:title" content="How ViewModels survive configuration changes | Arkadiusz Chmura"><meta property="og:description" content="Let&rsquo;s explore their implementation details to see how they achieve this."><meta property="og:type" content="article"><meta property="og:url" content="https://arkadiuszchmura.com/posts/how-viewmodels-survive-configuration-changes/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-26T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-26T00:00:00+00:00"><meta property="og:site_name" content="Arkadiusz Chmura"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://arkadiuszchmura.com/posts/"},{"@type":"ListItem","position":2,"name":"How ViewModels survive configuration changes","item":"https://arkadiuszchmura.com/posts/how-viewmodels-survive-configuration-changes/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How ViewModels survive configuration changes | Arkadiusz Chmura","name":"How ViewModels survive configuration changes","description":"Let\u0026rsquo;s explore their implementation details to see how they achieve this.","keywords":[],"wordCount":"2159","inLanguage":"en","datePublished":"2022-04-26T00:00:00Z","dateModified":"2022-04-26T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://arkadiuszchmura.com/posts/how-viewmodels-survive-configuration-changes/"},"publisher":{"@type":"Organization","name":"Arkadiusz Chmura","logo":{"@type":"ImageObject","url":"https://arkadiuszchmura.com/favicon.ico"}}}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel=stylesheet><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://arkadiuszchmura.com/ accesskey=h title="Arkadiusz Chmura (Alt + H)">Arkadiusz Chmura</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://arkadiuszchmura.com/archive/ title=Archive>Archive</a></li><li><a href=https://arkadiuszchmura.com/search/ title="Search (Alt + /)" data-no-instant accesskey=/>Search</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://arkadiuszchmura.com/>Home</a>&nbsp;»&nbsp;<a href=https://arkadiuszchmura.com/posts/>Posts</a></div><h1 class=post-title>How ViewModels survive configuration changes</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>April 26, 2022</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>11 min</span></span></div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>¶</a></h2><p>At Google I/O 2017, the Android Framework team introduced Architecture Components - a set of tools that significantly changed how many Android developers write and structure their apps. This post will focus on the internals of one of them - the <a href=https://developer.android.com/reference/androidx/lifecycle/ViewModel><code>ViewModel</code></a>.</p><p>The <code>ViewModel</code> class is designed to store and manage UI-related data in a lifecycle conscious way. The <code>ViewModel</code> class allows data to <strong>survive configuration changes</strong> such as screen rotations.</p><p>Usually, one of the first things we find out when learning Android development is that activities get re-created after configuration changes. When it happens, we lose all initialized variables and the view gets re-rendered. We get a completely new activity instance.</p><p>So when I first heard about the <code>ViewModel</code> class and what it can do, some questions immediately popped up in my head:</p><ol><li>How is it possible that <code>ViewModels</code> survive configuration changes given that the activities that hold them get destroyed and created again?</li><li>How does the newly created activity instance access a reference to the same <code>ViewModel</code> used by the previous activity instance?</li></ol><p>Recently I decided to find answers to those questions. I chose to dive into the Android&rsquo;s source code and explore the <code>ViewModel</code>&rsquo;s implementation details.</p><h2 id=creating-a-viewmodel>Creating a ViewModel<a hidden class=anchor aria-hidden=true href=#creating-a-viewmodel>¶</a></h2><p>Let&rsquo;s start from the beginning. The recommended approach (at the time of writing this post) to create an instance of a <code>ViewModel</code> class inside an activity is to use the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>val</span> <span class=py>viewModel</span><span class=p>:</span> <span class=n>MyViewModel</span> <span class=k>by</span> <span class=n>viewModels</span><span class=p>()</span>
</span></span></code></pre></div><p>where <code>by viewModels()</code> is a syntax representing <a href=https://kotlinlang.org/docs/delegated-properties.html>Kotlin delegated properties</a>.</p><p>The <code>viewModels()</code> function returns a <code>Lazy&lt;T></code> instance, which serves as a lazy property delegate. This basically means that a <code>MyViewModel</code> instance is going to be obtained on first access to the <code>viewModel</code> variable (not when this variable is declared).</p><p>Here is what the <code>viewModels()</code> function looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>public</span> <span class=k>inline</span> <span class=k>fun</span> <span class=p>&lt;</span><span class=k>reified</span> <span class=nc>VM</span> <span class=p>:</span> <span class=nc>ViewModel</span><span class=p>&gt;</span> <span class=nf>ComponentActivity</span><span class=p>.</span><span class=n>viewModels</span><span class=p>(</span>  
</span></span><span class=line><span class=cl>    <span class=k>noinline</span> <span class=n>factoryProducer</span><span class=p>:</span> <span class=p>(()</span> <span class=o>-&gt;</span> <span class=n>Factory</span><span class=p>)?</span> <span class=p>=</span> <span class=k>null</span>  
</span></span><span class=line><span class=cl><span class=p>):</span> <span class=n>Lazy</span><span class=p>&lt;</span><span class=n>VM</span><span class=p>&gt;</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>factoryPromise</span> <span class=p>=</span> <span class=n>factoryProducer</span> <span class=o>?:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>defaultViewModelProviderFactory</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ViewModelLazy</span><span class=p>(</span><span class=n>VM</span><span class=o>::</span><span class=k>class</span><span class=p>,</span> <span class=p>{</span> <span class=n>viewModelStore</span> <span class=p>},</span> <span class=n>factoryPromise</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It accepts a single parameter - a <code>factoryProducer</code>. If it&rsquo;s specified, the <code>ViewModelProvider.Factory</code> returned by this lambda will be used to create a <code>ViewModel</code> instance. If not, the default one will be used.</p><p>The function returns an instance of the <code>ViewModelLazy</code> class which is an implementation of the <code>Lazy</code> interface that I mentioned earlier.</p><p>The <code>ViewModelLazy</code>&rsquo;s constructor takes three parameters. The first one represents a class of the <code>ViewModel</code> we want to create an instance of. The third one is a lambda that returns a <code>ViewModelProvider.Factory</code>. It&rsquo;s the same one as the one passed to the <code>viewModels()</code> function (or a default one).</p><p>The second parameter is interesting. It&rsquo;s a lambda that returns a <code>ViewModelStore</code>. Here, a lambda is passed that returns a <code>viewModelStore</code> variable. Where is this variable coming from?</p><p>As you can see, the <code>viewModels()</code> function is an extension function on the <code>ComponentActivity</code> class. So when we call <code>viewModelStore</code> in Kotlin, we effectively invoke the <code>getViewModelStore()</code> method from the <code>ComponentActivity</code> (written in Java) that returns its member variable called <code>mViewModelStore</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>ViewModelStore</span> <span class=nf>getViewModelStore</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>getApplication</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Your activity is not yet attached to the &#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34;Application instance. You can&#39;t request ViewModel before onCreate call.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>ensureViewModelStore</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mViewModelStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>The reason why the <code>ComponentActivity</code> has this method is that it implements the <code>ViewModelStoreOwner</code> interface. This is its declaration:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * A scope that owns {@link ViewModelStore}.
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * A responsibility of an implementation of this interface is to retain owned ViewModelStore
</span></span></span><span class=line><span class=cl><span class=cm> * during the configuration changes and call {@link ViewModelStore#clear()}, when this scope is
</span></span></span><span class=line><span class=cl><span class=cm> * going to be destroyed.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @see ViewTreeViewModelStoreOwner
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;WeakerAccess&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>ViewModelStoreOwner</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Returns owned {@link ViewModelStore}
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return a {@code ViewModelStore}
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@NonNull</span>
</span></span><span class=line><span class=cl>    <span class=n>ViewModelStore</span> <span class=nf>getViewModelStore</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Now you may ask: &ldquo;What is <code>ViewModelStore</code>?&rdquo;</p><p>As the name suggests, the <code>ViewModelStore</code> class is responsible for <strong>storing</strong> instances of <code>ViewModels</code>. This is what this class looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ViewModelStore</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>ViewModel</span><span class=o>&gt;</span> <span class=n>mMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>void</span> <span class=nf>put</span><span class=o>(</span><span class=n>String</span> <span class=n>key</span><span class=o>,</span> <span class=n>ViewModel</span> <span class=n>viewModel</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ViewModel</span> <span class=n>oldViewModel</span> <span class=o>=</span> <span class=n>mMap</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>viewModel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>oldViewModel</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>oldViewModel</span><span class=o>.</span><span class=na>onCleared</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ViewModel</span> <span class=nf>get</span><span class=o>(</span><span class=n>String</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mMap</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>keys</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;&gt;(</span><span class=n>mMap</span><span class=o>.</span><span class=na>keySet</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>clear</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>ViewModel</span> <span class=n>vm</span> <span class=o>:</span> <span class=n>mMap</span><span class=o>.</span><span class=na>values</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>vm</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>mMap</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>This relatively simple class serves as a wrapper around <code>HashMap&lt;String, ViewModel></code>. This is the ultimate place where all <code>ViewModels</code> associated with an activity or a fragment are stored.</p><p>Now, since we know what the <code>ViewModelStore</code> is, it&rsquo;s clear what the <code>ViewModelStoreOwner</code> interface is used for. A class that implements it indicates to the outside world that it owns an instance of the <code>ViewModelStore</code>.</p><p>This is a list of all classes in the Android framework that implement the <code>getViewModelStore()</code> method from the <code>ViewModelStoreOwner</code> interface. Basically, it&rsquo;s only activities and fragments.</p><figure class=align-center><img loading=lazy src=/getViewModelStore.png#center alt="Classes that implement getViewModelStore() from the ViewModelStoreOwner"><figcaption><p>Classes that implement <code>getViewModelStore()</code> from the <code>ViewModelStoreOwner</code></p></figcaption></figure><p>Let&rsquo;s look at the documentation from the <code>ViewModelStoreOwner</code> interface, particularly this fragment:</p><blockquote><p>A responsibility of an implementation of this interface is to retain owned <code>ViewModelStore</code> during the configuration changes and call <code>ViewModelStore#clear()</code>, when this scope is going to be destroyed.</p></blockquote><p>This gives us a valuable hint. It means that it&rsquo;s the <strong>activity&rsquo;s (or fragment&rsquo;s) responsibility</strong> to make sure that its <code>ViewModelStore</code> (along with all <code>ViewModels</code>) is preserved across configuration changes.</p><p>How do activities handle that? We will come back to this question in the next section.</p><p>For now, let&rsquo;s go back again to the <code>viewModels()</code> function and see what the newly constructed <code>ViewModelLazy</code> class looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>ViewModelLazy</span><span class=p>&lt;</span><span class=n>VM</span> <span class=p>:</span> <span class=n>ViewModel</span><span class=p>&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>viewModelClass</span><span class=p>:</span> <span class=n>KClass</span><span class=p>&lt;</span><span class=n>VM</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>storeProducer</span><span class=p>:</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>ViewModelStore</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>factoryProducer</span><span class=p>:</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=nc>ViewModelProvider</span><span class=p>.</span><span class=n>Factory</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>Lazy</span><span class=p>&lt;</span><span class=n>VM</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>var</span> <span class=py>cached</span><span class=p>:</span> <span class=n>VM</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>val</span> <span class=py>value</span><span class=p>:</span> <span class=n>VM</span>
</span></span><span class=line><span class=cl>        <span class=k>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>cached</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>if</span> <span class=p>(</span><span class=n>viewModel</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=py>factory</span> <span class=p>=</span> <span class=n>factoryProducer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=py>store</span> <span class=p>=</span> <span class=n>storeProducer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>ViewModelProvider</span><span class=p>(</span><span class=n>store</span><span class=p>,</span> <span class=n>factory</span><span class=p>).</span><span class=k>get</span><span class=p>(</span><span class=n>viewModelClass</span><span class=p>.</span><span class=n>java</span><span class=p>).</span><span class=n>also</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>cached</span> <span class=p>=</span> <span class=k>it</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>viewModel</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>isInitialized</span><span class=p>():</span> <span class=n>Boolean</span> <span class=p>=</span> <span class=n>cached</span> <span class=o>!=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Most of the code in this class just deals with caching the object and making sure that the same instance is returned on subsequent calls.</p><p>The most relevant fragment is this one:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>ViewModelProvider</span><span class=p>(</span><span class=n>store</span><span class=p>,</span> <span class=n>factory</span><span class=p>).</span><span class=k>get</span><span class=p>(</span><span class=n>viewModelClass</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span></code></pre></div><p>It creates an instance of the <code>ViewModelProvider</code> class by passing the required parameters (that were created by executing the lambdas passed to the constructor) and calls <code>get()</code> to obtain our <code>ViewModel</code>.</p><p>Here&rsquo;s the <code>get()</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>public</span> <span class=k>open</span> <span class=k>operator</span> <span class=k>fun</span> <span class=p>&lt;</span><span class=nc>T</span> <span class=p>:</span> <span class=nc>ViewModel</span><span class=p>&gt;</span> <span class=nf>get</span><span class=p>(</span><span class=n>modelClass</span><span class=p>:</span> <span class=n>Class</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;):</span> <span class=n>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>canonicalName</span> <span class=p>=</span> <span class=n>modelClass</span><span class=p>.</span><span class=n>canonicalName</span>
</span></span><span class=line><span class=cl>        <span class=o>?:</span> <span class=k>throw</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s2>&#34;Local and anonymous classes can not be ViewModels&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>get</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$DEFAULT</span><span class=s2>_KEY:</span><span class=si>$canonicalName</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>modelClass</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This methods call another <code>get()</code> method that additionally accepts a key as a parameter. In this case, the key is a concatenated string consisting of two parts separated by a colon:</p><ul><li>A <code>DEFAULT_KEY</code> value (which is <code>"androidx.lifecycle.ViewModelProvider.DefaultKey"</code>).</li><li>A canonical name of our <code>ViewModel</code> class.</li></ul><p>This key will be used to identify our <code>ViewModel</code> object in the <code>HashMap&lt;String, ViewModel></code> that we saw earlier in the <code>ViewModelStore</code> class.</p><p>Here&rsquo;s the second <code>get()</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>public</span> <span class=k>open</span> <span class=k>operator</span> <span class=k>fun</span> <span class=p>&lt;</span><span class=nc>T</span> <span class=p>:</span> <span class=nc>ViewModel</span><span class=p>&gt;</span> <span class=nf>get</span><span class=p>(</span><span class=n>key</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span> <span class=n>modelClass</span><span class=p>:</span> <span class=n>Class</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;):</span> <span class=n>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>store</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>modelClass</span><span class=p>.</span><span class=n>isInstance</span><span class=p>(</span><span class=n>viewModel</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>factory</span> <span class=k>as</span><span class=p>?</span> <span class=n>OnRequeryFactory</span><span class=p>)</span><span class=o>?.</span><span class=n>onRequery</span><span class=p>(</span><span class=n>viewModel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>viewModel</span> <span class=k>as</span> <span class=n>T</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Suppress</span><span class=p>(</span><span class=s2>&#34;ControlFlowWithEmptyBody&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>viewModel</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// TODO: log a warning.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>viewModel</span> <span class=p>=</span> <span class=k>if</span> <span class=p>(</span><span class=n>factory</span> <span class=k>is</span> <span class=n>KeyedFactory</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>factory</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>modelClass</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>factory</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>modelClass</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>store</span><span class=p>.</span><span class=n>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>viewModel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>viewModel</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Without going into too many details, this method basically returns an existing <code>ViewModel</code> specified by the key (if there is one) or creates a new one of the desired type using the provided factory.</p><p>Here we can see the <code>ViewModelStore</code> in action. It&rsquo;s used to get an existing <code>ViewModel</code> instance (<code>var viewModel = store[key]</code>) or to store a newly created one (<code>store.put(key, viewModel)</code>).</p><p>At this point, we&rsquo;ve finally obtained the <code>ViewModel</code> instance that we wanted. It was either the one we already had access to or a completely new instance.</p><p>Ok, we’ve covered a lot of ground. It might be worth pausing for a moment to wrap up what we’ve found so far:</p><ul><li>Every activity and fragment (from the <code>androidx</code> packages) has a component called <code>ViewModelStore</code>. How do we know it? They declare this fact by implementing the <code>ViewModelStoreOwner</code> interface. The <code>ViewModelStore</code> has references to all <code>ViewModels</code> used by this activity or fragment. This component is preserved across configuration changes. Later in this post, we will see how it&rsquo;s done.</li><li>When we call <code>private val viewModel: MyViewModel by viewModels()</code> in our activity (or fragment), we create a lazy property delegate that will initialize our <code>ViewModel</code> when we first access the <code>viewModel</code> variable. Internally, the code will create a correct instance and store it in the activity&rsquo;s (or fragment&rsquo;s) <code>ViewModelStore</code> or return the previous instance instead (if there was one).</li></ul><h2 id=the-survival>The survival<a hidden class=anchor aria-hidden=true href=#the-survival>¶</a></h2><p>We learned that it&rsquo;s the <code>ViewModelStore</code> that stores our <code>ViewModels</code>. The original question:</p><blockquote><p>How ViewModels survive configuration changes?</p></blockquote><p>can therefore be rephrased to:</p><blockquote><p>How <strong>ViewModelStores</strong> survive configuration changes?</p></blockquote><p>Let&rsquo;s focus on activities. Going back to the <code>getViewModelStore()</code> method from the <code>ComponentActivity</code>, we can notice that it calls another method called <code>ensureViewModelStore()</code> before returning its member instance.</p><p>As a refresher, here&rsquo;s the <code>getViewModelStore()</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>ViewModelStore</span> <span class=nf>getViewModelStore</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>getApplication</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Your activity is not yet attached to the &#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>+</span> <span class=s>&#34;Application instance. You can&#39;t request ViewModel before onCreate call.&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>ensureViewModelStore</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mViewModelStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>and this is the <code>ensureViewModelStore()</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span> <span class=nf>ensureViewModelStore</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>mViewModelStore</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NonConfigurationInstances</span> <span class=n>nc</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=o>(</span><span class=n>NonConfigurationInstances</span><span class=o>)</span> <span class=n>getLastNonConfigurationInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>nc</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Restore the ViewModelStore from NonConfigurationInstances
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>mViewModelStore</span> <span class=o>=</span> <span class=n>nc</span><span class=o>.</span><span class=na>viewModelStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mViewModelStore</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mViewModelStore</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ViewModelStore</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>And there we go! It seems that we&rsquo;ve found what we&rsquo;ve been looking for.</p><p>This method first checks if the <code>mViewModelStore</code> member variable is null. If it is, we <strong>restore</strong> the previous <code>ViewModelStore</code> (if there is any, otherwise, it creates a new one) using the <code>getLastNonConfigurationInstance()</code> method. This method returns an instance of the <code>NonConfigurationInstances</code> class that&rsquo;s defined as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>NonConfigurationInstances</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>custom</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=n>ViewModelStore</span> <span class=n>viewModelStore</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>As we can see, it has our <code>ViewModelStore</code> object.</p><p>Now we know how our <code>ViewModelStores</code> are restored. There is one final piece of the puzzle to solve. We need to find out how they are saved. Let&rsquo;s start by looking at the documentation of the<code>getLastNonConfigurationInstance()</code> method:</p><blockquote><p>Retrieve the non-configuration instance data that was previously returned by <code>onRetainNonConfigurationInstance()</code>.</p></blockquote><p>I think we are getting pretty close. Let&rsquo;s dive into the <code>onRetainNonConfigurationInstance()</code> method. First, this is what the documentation says about it:</p><blockquote><p>Called by the system, as part of destroying an activity due to a configuration change, when it is known that a new instance will immediately be created for the new configuration. You can return any object you like here, including the activity instance itself, which can later be retrieved by calling <code>getLastNonConfigurationInstance()</code> in the new activity instance.</p></blockquote><p>And this is what the method looks like in the <code>ComponentActivity</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=n>Object</span> <span class=nf>onRetainNonConfigurationInstance</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Skipping the irrelevant parts...
</span></span></span><span class=line><span class=cl><span class=c1></span>	
</span></span><span class=line><span class=cl>    <span class=n>NonConfigurationInstances</span> <span class=n>nci</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NonConfigurationInstances</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>nci</span><span class=o>.</span><span class=na>custom</span> <span class=o>=</span> <span class=n>custom</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>nci</span><span class=o>.</span><span class=na>viewModelStore</span> <span class=o>=</span> <span class=n>viewModelStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nci</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>As you can see, this method prepares the instance of the <code>NonConfigurationInstances</code> class that will be retained across configuration change. It has our current <code>ViewModelStore</code> which means we will be able to successfuly restore it afterwards in the <code>getLastNonConfigurationInstance()</code>.</p><p>And that&rsquo;s it! All that seems so magical about <code>ViewModels</code> at first glance is just a combination of using this pair of methods from the <code>Activity</code> class:</p><ul><li><code>onRetainNonConfigurationInstance()</code></li><li><code>getLastNonConfigurationInstance()</code></li></ul><p>The process of saving and restoring the <code>ViewModelStore</code> in fragments is very similar. If you are interested, I encourage you to explore the source code to find it out by yourself.</p><h2 id=viewmodels-and-process-death>ViewModels and process death<a hidden class=anchor aria-hidden=true href=#viewmodels-and-process-death>¶</a></h2><p>Here&rsquo;s one thing worth keeping in mind. As mentioned in the introduction, the <code>ViewModel</code> class allows data to survive <strong>configuration changes</strong> such as screen rotations, enabling the multi-window mode, etc.</p><p>However, the system may destroy your application process while the user is away interacting with other apps. In such a case, the activity instance is destroyed, along with any state stored in it. This is called a <em>process death</em>. <code>ViewModels</code> <strong>don&rsquo;t survive</strong> a system-initiated process death.</p><p>This is why you should use <code>ViewModel</code> objects in combination with <code>onSaveInstanceState()</code> or some other disk persistence. To avoid some boilerplate when using the first approach, you might want to take a look at the <a href=https://developer.android.com/topic/libraries/architecture/viewmodel-savedstate>SavedStateHandle</a>.</p><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>¶</a></h2><p>In order to effectively use <code>ViewModels</code> in our Android apps, it&rsquo;s not necessary to entirely understand the details of their implementation. However, many developers are simply curious about how some things work behind the scenes. Knowledge of the internals can make it easier to spot potential edge cases or pitfalls and simplify debugging in the future.</p><p>I hope you learned something new after reading this post and that it satisfied your curiosity. If there are still some parts that you find confusing, feel free to reach me on <a href=https://twitter.com/ClouddJR/>Twitter</a> and ask some questions. I will do my best to answer them.</p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://arkadiuszchmura.com/posts/how-to-display-responsive-image-from-laravel-medialibrary-in-vue-js/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>How to display responsive images from Laravel-medialibrary in Vue.js</span></a>
<a class=next href=https://arkadiuszchmura.com/posts/my-key-takeaways-from-the-pragmatic-programmer/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>My key takeaways from The Pragmatic Programmer</span></a></nav></footer></article></main><footer class=footer><span></span>
<span>&copy; 2023 <a href=https://arkadiuszchmura.com/>Arkadiusz Chmura</a></span></footer><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script><script>mediumZoom(".entry-cover img"),mediumZoom(".post-content img:not([no-zoom])")</script></body></html>