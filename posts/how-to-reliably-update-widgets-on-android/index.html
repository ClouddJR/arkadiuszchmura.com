<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to reliably update widgets on Android | Arkadiusz Chmura</title><meta name=keywords content><meta name=description content="The default solution with android:updatePeriodMillis doesn&rsquo;t always work."><meta name=author content><link rel=canonical href=https://arkadiuszchmura.com/posts/how-to-reliably-update-widgets-on-android/><link crossorigin=anonymous href=/assets/css/stylesheet.min.fae4cfc4834f76ac6cce4ff8a96ca6d74c7182c0266a365ff62637f339447878.css integrity="sha256-+uTPxINPdqxszk/4qWym10xxgsAmajZf9iY38zlEeHg=" rel="preload stylesheet" as=style><link rel=icon href=https://arkadiuszchmura.com/favicon.ico><link rel=apple-touch-icon href=https://arkadiuszchmura.com/apple-touch-icon.png><meta name=twitter:title content="How to reliably update widgets on Android | Arkadiusz Chmura"><meta name=twitter:description content="The default solution with android:updatePeriodMillis doesn&rsquo;t always work."><meta property="og:title" content="How to reliably update widgets on Android | Arkadiusz Chmura"><meta property="og:description" content="The default solution with android:updatePeriodMillis doesn&rsquo;t always work."><meta property="og:type" content="article"><meta property="og:url" content="https://arkadiuszchmura.com/posts/how-to-reliably-update-widgets-on-android/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-12T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-12T00:00:00+00:00"><meta property="og:site_name" content="Arkadiusz Chmura"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://arkadiuszchmura.com/posts/"},{"@type":"ListItem","position":2,"name":"How to reliably update widgets on Android","item":"https://arkadiuszchmura.com/posts/how-to-reliably-update-widgets-on-android/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to reliably update widgets on Android | Arkadiusz Chmura","name":"How to reliably update widgets on Android","description":"The default solution with android:updatePeriodMillis doesn\u0026rsquo;t always work.","keywords":[],"wordCount":"788","inLanguage":"en","datePublished":"2022-02-12T00:00:00Z","dateModified":"2022-02-12T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://arkadiuszchmura.com/posts/how-to-reliably-update-widgets-on-android/"},"publisher":{"@type":"Organization","name":"Arkadiusz Chmura","logo":{"@type":"ImageObject","url":"https://arkadiuszchmura.com/favicon.ico"}}}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel=stylesheet><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://arkadiuszchmura.com/ accesskey=h title="Arkadiusz Chmura (Alt + H)">Arkadiusz Chmura</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://arkadiuszchmura.com/archive/ title=Archive>Archive</a></li><li><a href=https://arkadiuszchmura.com/search/ title="Search (Alt + /)" data-no-instant accesskey=/>Search</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://arkadiuszchmura.com/>Home</a>&nbsp;»&nbsp;<a href=https://arkadiuszchmura.com/posts/>Posts</a></div><h1 class=post-title>How to reliably update widgets on Android</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>February 12, 2022</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>4 min</span></span></div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>¶</a></h2><p>Users of <a href="https://play.google.com/store/apps/details?id=com.arkadiusz.dayscounter">one of my apps</a> heavily rely on widgets. They place them on their home screens to count days to specific events. It is therefore important to keep those widgets up to date and refresh them at least once per day.</p><p>Not long ago, I have been getting some emails (as well as 1-star reviews) from my users reporting that their widgets are not being updated properly on their phones.</p><p>The Android documentation says that to update a widget periodically at some interval, you can specify <code>android:updatePeriodMillis</code> attribute on the widget&rsquo;s metadata - AppWidgetProviderInfo XML.</p><p>Unfortunately, despite setting this attribute in my app, widgets were still not updated reliably on some users&rsquo; phones.</p><p>The problem might be that some vendors <a href=https://dontkillmyapp.com/problem>introduce their own set of rules</a> that restrict background processing and ignore this attribute altogether under some circumstances to artificially save some battery life.</p><h2 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>¶</a></h2><p>Since I could not count on this attribute alone, I needed another solution to support it. Luckily, Android Jetpack has a component that could help me periodically update widgets - WorkManager. As of writing this article, it is the primary recommended API for background processing.</p><p>Quoting the documentation, WorkManager handles three types of persistent work:</p><ul><li><strong>Immediate</strong>: Tasks that must begin immediately and complete soon. May be expedited.</li><li><strong>Long Running</strong>: Tasks which might run for longer, potentially longer than 10 minutes.</li><li><strong>Deferrable</strong>: Scheduled tasks that start at a later time and can run periodically.</li></ul><p>Support for the third type of work perfectly matched my use case so I decided to give it a try.</p><p>Here are the steps I took to import and setup WorkManager in my app:</p><p><strong>1. Import the library into your Android project (<a href=https://developer.android.com/jetpack/androidx/releases/work>using the newest version</a>):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gradle data-lang=gradle><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>val</span> <span class=n>work_version</span> <span class=o>=</span> <span class=s2>&#34;2.7.1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Java only
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>implementation</span><span class=o>(</span><span class=s2>&#34;androidx.work:work-runtime:$work_version&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Kotlin + coroutines
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>implementation</span><span class=o>(</span><span class=s2>&#34;androidx.work:work-runtime-ktx:$work_version&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><strong>2. Define the work</strong></p><p>Here we specify what our work actually <strong>does</strong>. We do this by creating our own implementation of the <code>Worker</code> class and overriding the <code>doWork()</code> method. This method runs asynchronously on a background thread provided by WorkManager.</p><p>In this case, we simply grab a list of relevant widget ids and notify the AppWidgetManager to perform an update on them by sending an Intent.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>WidgetUpdateWorker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>appContext</span><span class=p>:</span> <span class=n>Context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>workerParams</span><span class=p>:</span> <span class=n>WorkerParameters</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>Worker</span><span class=p>(</span><span class=n>appContext</span><span class=p>,</span> <span class=n>workerParams</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>doWork</span><span class=p>():</span> <span class=n>Result</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// This line might be different in your case
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>widgetIds</span> <span class=p>=</span> <span class=nc>DatabaseRepository</span><span class=p>.</span><span class=n>getWidgetIds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>intent</span> <span class=p>=</span> <span class=n>Intent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nc>AppWidgetManager</span><span class=p>.</span><span class=n>ACTION_APPWIDGET_UPDATE</span><span class=p>,</span> <span class=k>null</span><span class=p>,</span> <span class=n>appContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>MyAppWidgetProvider</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span><span class=p>.</span><span class=n>putExtra</span><span class=p>(</span><span class=nc>AppWidgetManager</span><span class=p>.</span><span class=n>EXTRA_APPWIDGET_IDS</span><span class=p>,</span> <span class=n>widgetIds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>appContext</span><span class=p>.</span><span class=n>sendBroadcast</span><span class=p>(</span><span class=n>intent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nc>Result</span><span class=p>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>One thing to note here - <code>MyAppWidgetProvider</code> is a subclass of the <code>AppWidgetProvider</code> that is needed when creating a widget.</p><p><strong>3. Define WorkRequest and schedule it</strong></p><p>Now that we defined our work, it is necessary to specify <strong>how</strong> and <strong>when</strong> that work should be run. We do this by defining a <code>WorkRequest</code>. In our case, we simply want to run the work periodically at some interval.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>widgetUpdateRequest</span> <span class=p>=</span> <span class=n>PeriodicWorkRequestBuilder</span><span class=p>&lt;</span><span class=n>WidgetUpdateWorker</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>    <span class=m>4</span><span class=p>,</span> <span class=nc>TimeUnit</span><span class=p>.</span><span class=n>HOURS</span>
</span></span><span class=line><span class=cl><span class=p>).</span><span class=n>build</span><span class=p>()</span>
</span></span></code></pre></div><p>Finally, we can put everything together and schedule our work. The code below could be placed in the <code>Application.onCreate()</code> or in your main activity&rsquo;s <code>onCreate()</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nc>WorkManager</span><span class=p>.</span><span class=n>getInstance</span><span class=p>(</span><span class=k>this</span><span class=p>).</span><span class=n>enqueueUniquePeriodicWork</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;widgetUpdateWork&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nc>ExistingPeriodicWorkPolicy</span><span class=p>.</span><span class=n>KEEP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>widgetUpdateRequest</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>The first parameter - <code>"widgetUpdateWork"</code> is a unique name that identifies the work.</p><p>The <code>ExistingPeriodicWorkPolicy.KEEP</code> flag tells the WorkManager to keep using the existing work if there is one already scheduled with the same name.</p><p>The third parameter is a <code>WorkRequest</code> that we&rsquo;ve just defined.</p><p>And that&rsquo;s it! The work is now scheduled and our widgets are going to be periodically updated.</p><p>As a side note, there are many benefits to using the WorkManager versus relying on the standard way of updating the widgets. Here are some of them:</p><ul><li>Once you specify the <code>android:updatePeriodMillis</code> attribute, it is fixed and cannot be changed in any other way than updating the app with a new value. On the other hand, you can let your users decide how often widgets should be updated with WorkManager and change this value at runtime.</li><li>WorkManager automatically ensures that the scheduled tasks are going to finish even when the OS decides to kill the app to reclaim some memory.</li><li>Internally, WorkManager uses JobScheduler (on API 23+) or a combination of AlarmManager and BroadcastReceiver on older versions. This makes it less likely to be restricted by some vendors.</li></ul><p>After introducing WorkManager, the number of emails from my users about their widgets not being updated properly dropped significantly.</p><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>¶</a></h2><p>To summarize, here are the key points from this post:</p><ul><li>Some vendors restrict background processing in order to save some battery life. Because of this, the standard way of updating widgets (with the <code>android:updatePeriodMillis</code> attribute) doesn&rsquo;t always work.</li><li>To solve this problem, we can introduce WorkManager that will periodically update widgets and make sure that they are up to date.</li></ul></div><footer class=post-footer><nav class=paginav><a class=prev href=https://arkadiuszchmura.com/posts/do-not-change-the-package-name-or-class-name-of-your-app-widget-provider/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>Do not change the package name or class name of your AppWidgetProvider</span></a>
<a class=next href=https://arkadiuszchmura.com/posts/beware-of-the-order-of-operands-in-some-kotlin-collection-operations/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>Beware of the order of operands in some Kotlin Collection operations</span></a></nav></footer></article></main><footer class=footer><span></span>
<span>&copy; 2023 <a href=https://arkadiuszchmura.com/>Arkadiusz Chmura</a></span></footer><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script><script>mediumZoom(".entry-cover img"),mediumZoom(".post-content img:not([no-zoom])")</script></body></html>