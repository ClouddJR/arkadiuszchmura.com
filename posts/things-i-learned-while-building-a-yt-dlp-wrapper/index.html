<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Things I learned while building a yt-dlp wrapper | Arkadiusz Chmura</title>
<meta name=keywords content><meta name=description content="An opportunity to learn new things is a great reason to pursue side project."><meta name=author content><link rel=canonical href=https://arkadiuszchmura.com/posts/things-i-learned-while-building-a-yt-dlp-wrapper/><link crossorigin=anonymous href=/assets/css/stylesheet.min.e3c510e7f6e31768ab67de3a6e99624800311d1e456b449249b149b07d3f1d65.css integrity="sha256-48UQ5/bjF2irZ946bpliSAAxHR5Fa0SSSbFJsH0/HWU=" rel="preload stylesheet" as=style><link rel=icon href=https://arkadiuszchmura.com/favicon.ico><link rel=apple-touch-icon href=https://arkadiuszchmura.com/apple-touch-icon.png><link rel=alternate hreflang=en href=https://arkadiuszchmura.com/posts/things-i-learned-while-building-a-yt-dlp-wrapper/><script async src="https://www.googletagmanager.com/gtag/js?id=G-9BS720SLJB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9BS720SLJB")}</script><meta name=twitter:title content="Things I learned while building a yt-dlp wrapper | Arkadiusz Chmura"><meta name=twitter:description content="An opportunity to learn new things is a great reason to pursue side project."><meta property="og:title" content="Things I learned while building a yt-dlp wrapper | Arkadiusz Chmura"><meta property="og:description" content="An opportunity to learn new things is a great reason to pursue side project."><meta property="og:type" content="article"><meta property="og:url" content="https://arkadiuszchmura.com/posts/things-i-learned-while-building-a-yt-dlp-wrapper/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-10T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-10T00:00:00+00:00"><meta property="og:site_name" content="Arkadiusz Chmura"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://arkadiuszchmura.com/posts/"},{"@type":"ListItem","position":2,"name":"Things I learned while building a yt-dlp wrapper","item":"https://arkadiuszchmura.com/posts/things-i-learned-while-building-a-yt-dlp-wrapper/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Things I learned while building a yt-dlp wrapper | Arkadiusz Chmura","name":"Things I learned while building a yt-dlp wrapper","description":"An opportunity to learn new things is a great reason to pursue side project.","keywords":[],"wordCount":"1013","inLanguage":"en","datePublished":"2024-10-10T00:00:00Z","dateModified":"2024-10-10T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://arkadiuszchmura.com/posts/things-i-learned-while-building-a-yt-dlp-wrapper/"},"publisher":{"@type":"Organization","name":"Arkadiusz Chmura","logo":{"@type":"ImageObject","url":"https://arkadiuszchmura.com/favicon.ico"}}}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel=stylesheet><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://arkadiuszchmura.com/ accesskey=h title="Arkadiusz Chmura (Alt + H)">Arkadiusz Chmura</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://arkadiuszchmura.com/archive/ title=Archive>Archive</a></li><li><a href=https://arkadiuszchmura.com/search/ title="Search (Alt + /)" data-no-instant accesskey=/>Search</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://arkadiuszchmura.com/>Home</a>&nbsp;»&nbsp;<a href=https://arkadiuszchmura.com/posts/>Posts</a></div><h1 class=post-title>Things I learned while building a yt-dlp wrapper</h1><div class=post-meta><span class=meta-item><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg>
<span>October 10, 2024</span></span><span class=meta-item>
<svg width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>5 min</span></span></div></header><div class=post-content><p>A couple of weeks ago, I launched <a href=https://clipsnag.com/>ClipSnag</a>, a native macOS wrapper for a popular command-line tool called <a href=https://github.com/yt-dlp/yt-dlp>yt-dlp</a>. The goal of this app is to provide the benefits of this wonderful tool to people who are not comfortable with a terminal or simply prefer GUI over command-line tools.</p><p>In this post, I would like to share the two things I learned while building this app:</p><h3 id=open-source-doesnt-mean-do-whatever-you-want>Open-source doesn&rsquo;t mean &ldquo;do whatever you want&rdquo;<a hidden class=anchor aria-hidden=true href=#open-source-doesnt-mean-do-whatever-you-want>¶</a></h3><p>The fact that software is open-sourced doesn&rsquo;t mean you can do absolutely everything you want with it. Each open-source software is released under a specific license that describes how the software can be used, modified, and shared.</p><p>For example, the <code>yt-dlp</code> program is released under the <a href="https://github.com/yt-dlp/yt-dlp?tab=Unlicense-1-ov-file">&ldquo;Unlicense license&rdquo;</a>. It&rsquo;s a public domain equivalent license, which allows you to use, modify, distribute, or even sell the software without asking for permission or giving credit. This license would allow me to include <code>yt-dlp</code> as part of my own, paid app without any issues.</p><p>However, <code>yt-dlp</code> has several dependencies. All of them are optional, but two are highly recommended - <code>ffmpeg</code> and <code>ffprobe</code>, without which my app doesn&rsquo;t work. They are used for merging video and audio files, converting between formats, as well as for various post-processing tasks. Most of their codebases are released under the <a href=https://opensource.org/license/lgpl-2-1>&ldquo;LGPL v2.1+&rdquo;</a> license. The license states that any &ldquo;derivative&rdquo; work must be distributed under the same or equivalent license terms. This effectively means that if I were to bundle <code>ffmpeg</code> and <code>ffprobe</code> executables within my app, I would have to make the app open-source as well and provide it under the same license.</p><p>Since open-sourcing the app wasn&rsquo;t my intention, I had to find a different solution, and that solution would have to be aligned with the target audience for the app - potentially non-tech-savvy users. I wanted people to be able to download my app and start using it immediately without having to worry about downloading all of the necessary tools mentioned above manually. And how was I supposed to do that if I can&rsquo;t include them as part of my app because of the license restrictions?</p><p>The exploration related to this question brought me to my second finding:</p><h3 id=macos-allows-apps-to-download-and-execute-arbitrary-executables>macOS allows apps to download and execute arbitrary executables<a hidden class=anchor aria-hidden=true href=#macos-allows-apps-to-download-and-execute-arbitrary-executables>¶</a></h3><p>Firstly, let&rsquo;s see what happens from the user&rsquo;s perspective when they download an executable using their browser and try to run it.</p><p>On my machine (running macOS Sonoma), this is what I got after I <a href=https://evermeet.cx/ffmpeg/>downloaded</a> FFmpeg, unzipped it, and either opened it by double-clicking or typed <code>./ffmpeg</code> in my terminal:</p><figure class=align-center><img loading=lazy src=/yt-dlp/1.png#center width=300></figure><p>The reason for this alert is the <a href=https://en.wikipedia.org/wiki/Gatekeeper_(macOS)>Gatekeeper</a> mechanism. By default, it verifies that any software you intend to run for the first time is from an identified developer, is notarised by Apple to be free of known malicious content (since macOS Catalina), and hasn’t been altered.</p><p>In this case, the <code>ffmpeg</code> binary isn&rsquo;t signed by a certified Apple Developer hence the warning that &ldquo;the developer cannot be verified&rdquo;. One way to work around this is to open System Settings, go to the &ldquo;Privacy & Security&rdquo; tab, and click on &ldquo;Allow Anyway&rdquo; in the section mentioning <code>ffmpeg</code>:</p><figure class=align-center><img loading=lazy src=/yt-dlp/2.png#center></figure><p>Then we can run the program again and confirm the will to open:</p><figure class=align-center><img loading=lazy src=/yt-dlp/3.png#center width=350></figure><p>As you can see, a lot of steps are required - downloading the archive, unzipping it, running the executable, clicking &ldquo;Allow Anyway&rdquo; in the settings, running again, and finally, confirming. Given that my app requires three external dependencies, which can&rsquo;t be bundled because of the license restrictions, the above steps would have to be performed three times, manually.</p><p>I considered preparing a detailed instruction for a manual installation of all of these tools for my users, but that would be way too much to ask from them, especially given that the app is paid. It should run out of the box, without any additional work.</p><p>This almost led me to abandon the app altogether, but then I realized that none of the above steps are necessary when downloading an executable using a non-browser tool, like <code>curl</code> or a simple Python script.</p><p>Why is that?</p><p>Firstly, it turns out that what triggers all of the Gatekeeper checks is the <code>com.apple.quarantine</code> extended attribute that is attached to all downloaded files.</p><p>If we run the <code>xattr</code> program (that&rsquo;s used to work with extended attributes) on the downloaded <code>ffmpeg</code> executable, we can see that indeed, this attribute is present:</p><figure class=align-center><img loading=lazy src=/yt-dlp/4.png#center width=350></figure><p>Secondly, Gatekeeper will <strong>only</strong> verify applications that have the quarantine flag. The problem is that this flag is added by other applications, not by the operating system itself. It&rsquo;s the responsibility of app developers to make sure that this flag is added to any files downloaded by the app.</p><p>Apps like web browsers or email clients properly attach the quarantine flag to all downloaded files, but many don&rsquo;t, like most BitTorrent client software. The flag is also not added if the app came from a different source, like network shares or USB drives.</p><p>To illustrate this, let&rsquo;s download <code>ffmpeg</code> again, this time using <code>curl</code>. Then, when we unzip it and run <code>xattr</code> on the executable, we can see that there is no quarantine flag attached. Also, running doesn&rsquo;t trigger any alerts displayed by the OS:</p><figure class=align-center><img loading=lazy src=/yt-dlp/5.png#center></figure><p>We bypassed all Gatekeeper checks by simply using a program that doesn&rsquo;t attach the quarantine flag (that&rsquo;s one of the reasons why this mechanism received some <a href=https://en.wikipedia.org/wiki/Gatekeeper_(macOS)#Implications>criticism</a>).</p><p>I used the exact same &ldquo;trick&rdquo; in my app. Instead of bundling <code>yt-dlp</code>, <code>ffmpeg</code>, and <code>ffprobe</code> within my app, which would violate the licenses, or requiring users to download them manually, I simply download the dependencies upon the first app launch and store them outside of the app in the user&rsquo;s home directory, without disrespecting the licenses.</p><p>Problem solved!</p><hr><p>One final, but very important, thing to note is that the above little experiment proves that it&rsquo;s always crucial to make sure that we only open apps we trust. On the surface, the <code>Gatekeeper</code> mechanism sounds great and you would think it fully protects your computer against running potentially malicious executables, but, as we&rsquo;ve seen, that&rsquo;s unfortunately not always the case.</p></div><footer class=post-footer><nav class=paginav><a class=next href=https://arkadiuszchmura.com/posts/optimizing-your-workflow-does-matter-in-the-long-run/><span class=title>Next Page&nbsp;<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>Optimizing your workflow does matter in the long run</span></a></nav></footer><div class=comments-separator></div><script src=https://utteranc.es/client.js repo=ClouddJR/arkadiuszchmura.com issue-term=pathname label=comments crossorigin=anonymous async></script><script>function updateUtterancesTheme(e){const t=document.querySelector(".utterances-frame");if(t){const n={type:"set-theme",theme:e?"github-light":"github-dark"};t.contentWindow.postMessage(n,"https://utteranc.es")}}function handleMessageEvent(e){if(e.origin!=="https://utteranc.es")return;const t=!document.body.classList.contains("dark");updateUtterancesTheme(t),removeEventListener("message",handleMessageEvent)}addEventListener("message",handleMessageEvent),toggleThemeCallbacks.comments=updateUtterancesTheme</script></article></main><footer class=footer><span></span>
<span>&copy; 2024 <a href=https://arkadiuszchmura.com/>Arkadiusz Chmura</a></span></footer><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script><script>mediumZoom(".entry-cover img"),mediumZoom(".post-content img:not([no-zoom])")</script></body></html>